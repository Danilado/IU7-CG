var z=Object.defineProperty;var X=(i,t,e)=>t in i?z(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var h=(i,t,e)=>(X(i,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class l{constructor(t,e){h(this,"x");h(this,"y");t===void 0?(this.x=0,this.y=0):t instanceof l?(this.x=t.x,this.y=t.y):typeof t=="number"?(this.x=t,this.y=e||0):(this.x=parseFloat(t[0]),this.y=parseFloat(t[1]))}toString(){return`${this.x} ${this.y}`}collinear(t,e){return y((this.y-t.y)*(this.x-e.x)-(this.y-e.y)*(this.x-t.x))<p}equalTo(t){return y(t.x-this.x)<p&&y(t.y-this.y)<p}}class G{constructor(t){h(this,"node");this.node=t}write(t,e){this.node.innerHTML+=e+t.replace(/\n/,"<br />")+"<br />",this.scrollToBottom()}clear(){this.node.innerHTML=""}warn(t){}log(t){}error(t){this.write(t,"ERROR: ")}scrollToBottom(){this.node.scroll(0,this.node.scrollHeight)}}const V=document.querySelector(".footertext"),T=new G(V),k=Math,u=k.floor,E=k.round,Y=k.min,K=k.max,y=k.abs,p=1e-6,j=(i,t)=>{let e=i.getBoundingClientRect();return new l(E(t.clientX-e.left),E(t.clientY-e.top))};function J(i){i instanceof Error?T.error(i.message):T.error(`${i}`)}function H(i){return parseInt(i,16)}function D(i){return i=i.replace(/#/,""),{r:H(i[0]+i[1]),g:H(i[2]+i[3]),b:H(i[4]+i[5])}}function m(i,t){if(t.x<0||t.x>=i.width||t.y<0||t.y>=i.height)return;let e=(t.x+t.y*i.width)*4;i.data[e]=t.r,i.data[e+1]=t.g,i.data[e+2]=t.b,i.data[e+3]=t.alpha}function B(i,t){if(t.x<0||t.x>=i.width||t.y<0||t.y>=i.height)return;let e=(t.x+t.y*i.width)*4,s=i.data[e],r=i.data[e+1],n=i.data[e+2],a=i.data[e+3];i.data[e]=t.r*t.alpha/255+s*a*(255-t.alpha)/(255*255),i.data[e+1]=t.g*t.alpha/255+r*a*(255-t.alpha)/(255*255),i.data[e+2]=t.b*t.alpha/255+n*a*(255-t.alpha)/(255*255),i.data[e+3]=t.alpha+a*(255-t.alpha)/255}function L(i){return i-u(i)}function w(i){return 1-L(i)}function q(i,t,e,s,r,n,a=!1){if(a||T.log("Работает Алгоритм Ву"),y(t-s)<p&&y(e-r)<p)return m(i,{x:E(t),y:E(e),r:n.r,g:n.g,b:n.b,alpha:255});let o=y(r-e)>y(s-t);if(o){let d=t;t=e,e=d,d=s,s=r,r=d}if(t>s){let d=t;t=s,s=d,d=r,r=e,e=d}let P=s-t,C=r-e,g;y(P)<p?g=1:g=C/P;let f=E(t),c=e+g*(f-t),_=w(t+.5),v=f,R=u(c);o?(B(i,{x:R,y:v,r:n.r,g:n.g,b:n.b,alpha:w(c)*_*255}),B(i,{x:R+1,y:v,r:n.r,g:n.g,b:n.b,alpha:L(c)*_*255})):(B(i,{x:v,y:R,r:n.r,g:n.g,b:n.b,alpha:w(c)*_*255}),B(i,{x:v,y:R+1,r:n.r,g:n.g,b:n.b,alpha:L(c)*_*255}));let b=c+g;f=E(s),c=r+g*(f-s),_=w(s+.5);let x=f,S=u(c);o?(m(i,{x:S,y:x,r:n.r,g:n.g,b:n.b,alpha:w(c)*_*255}),m(i,{x:S+1,y:x,r:n.r,g:n.g,b:n.b,alpha:L(c)*_*255})):(m(i,{x,y:S,r:n.r,g:n.g,b:n.b,alpha:w(c)*_*255}),m(i,{x,y:S+1,r:n.r,g:n.g,b:n.b,alpha:L(c)*_*255}));let F=Math.sign(x-v);if(o)for(let d=v+1;d!=x;d+=F)m(i,{x:u(b),y:d,r:n.r,g:n.g,b:n.b,alpha:w(b)*255}),m(i,{x:u(b)+1,y:d,r:n.r,g:n.g,b:n.b,alpha:L(b)*255}),b+=g;else for(let d=v+1;d!=x;d+=F)m(i,{x:d,y:u(b),r:n.r,g:n.g,b:n.b,alpha:w(b)*255}),m(i,{x:d,y:u(b)+1,r:n.r,g:n.g,b:n.b,alpha:L(b)*255}),b+=g}class Q{static build(t){let e=this.buildMain(),s=this.buildTexinput(e);s.placeholder="x",s.id="x";let r=this.buildTexinput(e);if(r.placeholder="y",r.id="y",t!==!0){let n=this.buildBtn(e);n.value="⨯",n.id="del"}return e}static buildMain(){let t=document.createElement("div");return t.classList.add("row"),t}static buildTexinput(t){let e=document.createElement("input");return e.type="text",e.classList.add("texinput"),t.appendChild(e),e}static buildBtn(t){let e=document.createElement("input");return e.type="button",e.classList.add("button"),t.appendChild(e),e}}class M{constructor(t,e,s){h(this,"node");h(this,"data");h(this,"x_i");h(this,"y_i");h(this,"del_btn");this.node=Q.build(s),t.appendChild(this.node),this.data={node:this.node,metadata:e},this.x_i=this.node.querySelector("#x"),this.y_i=this.node.querySelector("#y"),this.del_btn=this.node.querySelector("#del"),this.setupListeners()}setupListeners(){this.del_btn!==null&&this.setupDeleteListener(),this.setupChangeListeners()}setupDeleteListener(){this.del_btn.addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("point_delete",{bubbles:!0,detail:this.data}))})}setupChangeListeners(){this.x_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))}),this.y_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))})}set x(t){this.x_i.value=`${t}`}set y(t){this.y_i.value=`${t}`}set pt(t){this.x_i.value=`${t.x}`,this.y_i.value=`${t.y}`}get x(){let t=Number(this.x_i.value);return Number.isNaN(t)?0:t}get y(){let t=Number(this.y_i.value);return Number.isNaN(t)?0:t}get pt(){let t=Number(this.x_i.value);Number.isNaN(t)&&(t=0);let e=Number(this.y_i.value);return Number.isNaN(e)&&(e=0),new l(t,e)}validate(){let t=Number(this.x_i.value);if(Number.isNaN(t)||this.x_i.value==="")throw new Error(`Ошибка в значении координаты x поля ввода с данными ${this.data}`);let e=Number(this.y_i.value);if(Number.isNaN(e)||this.y_i.value==="")throw new Error(`Ошибка в значении координаты y поля ввода с данными ${this.data}`)}}class Z{static build(){let t=this.buildMain(),e=this.buildVerbal(t),s=this.buildRow(e);s.innerHTML='<div style="margin-left: auto">Отрезок</div>',s.id="name";let r=this.buildBtn(s);r.value="⨯",r.id="del";let n=this.buildPtsHolder(e);n.id="pts_holder";let a=this.buildRow(e),o=this.buildWideBtn(a);return o.id="inter",o.value="задать кликами",t}static buildMain(){let t=document.createElement("div");return t.classList.add("figure"),t}static buildVerbal(t){let e=document.createElement("div");return e.classList.add("verbal"),t.appendChild(e),e}static buildRow(t){let e=document.createElement("div");return e.classList.add("row"),t.appendChild(e),e}static buildPtsHolder(t){let e=document.createElement("div");return e.classList.add("verbal"),e.classList.add("high"),t.appendChild(e),e}static buildWideBtn(t){let e=document.createElement("input");return t.appendChild(e),e.type="button",e.classList.add("widebutton"),e}static buildBtn(t){let e=document.createElement("input");return e.type="button",e.classList.add("button"),t.appendChild(e),e}}class A{constructor(t,e){h(this,"node");h(this,"_pt1");h(this,"_pt2");h(this,"pts_node");h(this,"coordReqCallback");this.node=Z.build(),t.appendChild(this.node),this.coordReqCallback=e,this.pts_node=this.node.querySelector("#pts_holder"),this._pt1=new M(this.pts_node,{},!0),this._pt2=new M(this.pts_node,{},!0),this.setupListeners()}setupListeners(){this.setupInterListener(),this.setupMainListeners(),this.setupDelListener()}setupDelListener(){this.node.querySelector("#del").addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("figure_delete",{bubbles:!0,detail:{fig:this,node:this.node}}))})}setupInterListener(){this.node.querySelector("#inter").addEventListener("click",()=>{this.coordReqCallback(`Выберите первую точку отрезка
Или нажмите ПКМ для отмены`).then(e=>{this.coordReqCallback(`Выберите вторую точку отрезка
Или нажмите ПКМ для отмены`).then(s=>{this.pt1=e,this.pt2=s,this.dispatchUpdate()})})})}setupMainListeners(){this.node.addEventListener("point_change",t=>{t.stopPropagation(),this.dispatchUpdate()})}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}draw(t,e){try{this._pt1.validate()}catch{throw new Error("Ошибка ввода первой точки отрезка")}try{this._pt2.validate()}catch{throw new Error("Ошибка ввода первой точки отрезка")}q(t,this.x1,this.y1,this.x2,this.y2,e,!1)}get pt1(){return this._pt1.pt}set pt1(t){this._pt1.pt=t}get pt2(){return this._pt2.pt}set pt2(t){this._pt2.pt=t}get x1(){return this._pt1.x}set x1(t){this._pt1.x=t}get y1(){return this._pt1.y}set y1(t){this._pt1.y=t}get x2(){return this._pt2.x}set x2(t){this._pt2.x=t}get y2(){return this._pt2.y}set y2(t){this._pt2.y=t}}class tt{static build(t){let e=this.buildRow(t),s=this.buildPtsHolder(e);s.id="pts_holder",s.style.flex="1",s.style.height="6em",s.style.borderBottom="";let r=this.buildRow(t),n=this.buildWideBtn(r);n.id="add_pt",n.value="добавить точку";let a=this.buildRow(t),o=this.buildWideBtn(a);o.id="cont",o.value="продолжить кликами"}static buildRow(t){let e=document.createElement("div");return e.classList.add("row"),t.appendChild(e),e}static buildPtsHolder(t){let e=document.createElement("div");return e.classList.add("verbal"),t.appendChild(e),e}static buildWideBtn(t){let e=document.createElement("input");return t.appendChild(e),e.type="button",e.classList.add("widebutton"),e}}class et{constructor(t,e){h(this,"node");h(this,"points");h(this,"pts_node");h(this,"coordReqCallback");this.node=t,tt.build(t),this.coordReqCallback=e,this.points=[],this.pts_node=this.node.querySelector("#pts_holder"),this.setupListeners()}setupListeners(){this.setupAddPointListener(),this.setupContListener(),this.setupMainListeners()}setupAddPointListener(){this.node.querySelector("#add_pt").addEventListener("click",()=>{this.points.push(new M(this.pts_node,{}))})}setupContListener(){this.node.querySelector("#cont").addEventListener("click",()=>{let e=!0,s=()=>{this.coordReqCallback(`Последовательно выбирайте точки
ПКМ, чтобы отменить или завершить`).then(r=>{this.addPoint(r),this.dispatchUpdate()},()=>{e=!1}).finally(()=>{e&&s()})};s()})}addPoint(t){let e=new M(this.pts_node,{});e.pt=t,this.points.push(e),this.pts_node.scroll(0,this.pts_node.scrollHeight)}setupMainListeners(){this.node.addEventListener("point_delete",t=>{t.stopPropagation(),this.points=this.points.filter(e=>e.node!==t.detail.node),this.pts_node.removeChild(t.detail.node),this.dispatchUpdate()}),this.node.addEventListener("point_change",t=>{t.stopPropagation(),this.dispatchUpdate()})}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}getPoints(){return this.points.map(t=>t.pt)}draw(t,e){let s=this.getPoints();if(s.length<2)throw new Error("not enough points");for(let r=0;r<s.length-1;++r)q(t,s[r].x,s[r].y,s[r+1].x,s[r+1].y,e,!1);q(t,s[s.length-1].x,s[s.length-1].y,s[0].x,s[0].y,e,!1)}}class it{constructor(t,e,s){h(this,"container");h(this,"chain");h(this,"lines");h(this,"addChainBtn");h(this,"coordReqCallback");this.container=t,this.lines=[],this.addChainBtn=e,this.coordReqCallback=s,this.chain=new et(document.querySelector("#rect-div"),this.coordReqCallback),this.setupListeners()}addChain(){let t=new A(this.container,this.coordReqCallback);return this.lines.push(t),this.container.scroll(0,this.container.scrollHeight),t}removeFigure(t){this.lines=this.lines.filter(e=>e!==t),this.container.removeChild(t.node),this.dispatchUpdate()}clear(){for(this.lines=[];this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.dispatchUpdate()}dispatchUpdate(){this.container.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.container}}))}setupListeners(){this.setupAddChainListener(),this.setupDelListener()}setupDelListener(){this.container.addEventListener("figure_delete",t=>{t.stopPropagation(),this.removeFigure(t.detail.fig)})}setupAddChainListener(){this.addChainBtn.addEventListener("click",()=>{this.addChain()})}}class N{constructor(t,e,s,r){h(this,"pt1");h(this,"pt2");t instanceof N?(this.pt1=new l(t.pt1),this.pt2=new l(t.pt2)):e instanceof l?(this.pt1=new l(t),this.pt2=new l(e)):(this.pt1=new l(t,e),this.pt2=new l(s,r))}get x1(){return this.pt1.x}get y1(){return this.pt1.y}get x2(){return this.pt2.x}get y2(){return this.pt2.y}set x1(t){this.pt1.x=t}set y1(t){this.pt1.y=t}set x2(t){this.pt2.x=t}set y2(t){this.pt2.y=t}}function $(i,t){return i.x*t.x+i.y*t.y}function U(i,t){return i.x*t.y-i.y*t.x}function I(i,t){return new l(t.x-i.x,t.y-i.y)}function st(i){if(i.length<3)return!1;let t=I(i[0],i[1]),e=I(i[1],i[2]),s=U(t,e)>0?1:-1,r=i.length;for(let n=0;n<i.length;++n){let a=I(i[n],i[(n+1)%r]),o=I(i[(n+1)%r],i[(n+2)%r]);if(s*U(a,o)<0)return!1}return s<0&&(i=i.reverse()),!0}function nt(i,t,e){let s=new l(t.x-i.x,t.y-i.y),r=new l;return y(s.y)>p?(r.x=1,r.y=-s.x/s.y):(r.y=1,r.x=0),$(new l(e.x-t.x,e.y-t.y),r)<0&&(r.x*=-1,r.y*=-1),r}function rt(i,t){let e=i.length;if(e<3)return null;let s=0,r=1,n=new l(t.x2-t.x1,t.y2-t.y1);for(let a=0;a<i.length;++a){let o=nt(i[a],i[(a+1)%e],i[(a+2)%e]),P=new l(t.x1-i[a].x,t.y1-i[a].y),C=$(n,o),g=$(P,o);if(y(C)<p){if(g<p)return null;continue}let f=-g/C;if(C>0)if(f-1<=p)s=K(s,f);else return null;else if(C<0)if(f>=-p)r=Y(r,f);else return null;if(s>r)return null}return new N(new l(t.x1+n.x*s,t.y1+n.y*s),new l(t.x1+n.x*r,t.y1+n.y*r))}function ht(i,t){let e=[];return t.length?t.map(s=>rt(i,s)).filter(s=>s instanceof N):e}const W=document.querySelector(".c-width"),O=document.querySelector(".c-height");class at{constructor(t,e,s){h(this,"node");h(this,"out_renderer");h(this,"renderer");h(this,"ctx");h(this,"image");h(this,"ar");h(this,"choosing");h(this,"_width");h(this,"_height");let r=t.canvas.getBoundingClientRect();t.canvas.width=r.width,s.canvas.width=r.width,t.canvas.height=r.height,s.canvas.height=r.height,this.out_renderer=s,this.out_renderer.lineWidth=2,this.renderer=t,this.node=t.canvas,this.renderer.imageSmoothingEnabled=!1,this.ctx=document.createElement("canvas").getContext("2d"),this.ctx.lineWidth=2,this.renderer.lineWidth=2,this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._width=e,this._height=u(this._width/this.ar),this.width=e,this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(0),this.choosing=!1,this.ctx.strokeStyle="black"}get width(){return this._width}set width(t){this._width=t,this._height=u(this._width/this.ar),W.innerHTML=`${this._width}`,O.innerHTML=`${this._height}`,this.resetImage()}get height(){return this._height}set height(t){this._height=u(t),this._width=u(this._height*this.ar),W.innerHTML=`${this._width}`,O.innerHTML=`${this._height}`,this.resetImage()}update(){this.clearCtx(),this.drawImageData()}getBuf(){return this.image}putImageData(t){t instanceof ImageData?(this.image=t,this.update()):t.then(e=>{this.image=e,this.update()},e=>{throw e})}drawImageData(){this.renderer.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.ctx.putImageData(this.image,0,0),this.renderer.drawImage(this.ctx.canvas,0,0,this.width*this.getPixelSize(),u(this.height)*this.getPixelSize())}resizeCtx(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height}clearCtx(){this.ctx.clearRect(0,0,this.width,this.height),this.out_renderer.clearRect(0,0,this.width,this.height)}resetImage(){this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._height=this._width/this.ar,this.resizeCtx(),this.clearCtx(),this.renderer.clearRect(0,0,this.width,this.height),this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(0),this.drawImageData()}getPixelSize(){return this.renderer.canvas.getBoundingClientRect().width/this.width}drawLine(t,e,s){let r=this.getBuf(),n,a;e===void 0?a=void 0:e instanceof l?a=s:a=e,a===void 0?n={r:0,g:0,b:0}:typeof a=="string"?n=D(a):n=a,t instanceof N?q(r,t.x1,t.y1,t.x2,t.y2,n):q(r,t.x,t.y,e.x,e.y,n)}drawLines(t,e){if(!t.length)return;let s=this.getBuf(),r;if(e!==void 0&&e!=""?r=D(e):r={r:0,g:0,b:0},t[0]instanceof A)for(let n of t)try{n.draw(s,r)}catch(a){console.log(a)}else for(let n of t)try{this.drawLine(n,r)}catch(a){console.log(a)}this.drawImageData()}drawChain(t,e){let s=this.getBuf(),r;e!==void 0&&e!=""?r=D(e):r={r:0,g:0,b:0},t.draw(s,r),this.drawImageData()}}class lt{constructor(){h(this,"state","idle");h(this,"ff");h(this,"graphics");h(this,"blocker");h(this,"blockertext");h(this,"docff");h(this,"canv");h(this,"outline_canv");this.docff=document.querySelector("#figures"),this.ff=new it(this.docff,document.querySelector("#add_line"),t=>this.reqCanvasCoords(t)),this.blocker=document.querySelector(".blocker"),this.blockertext=document.querySelector(".blockertext"),this.canv=document.querySelector("#main_canvas"),this.outline_canv=document.querySelector("#outline_canvas"),this.graphics=new at(this.canv.getContext("2d"),this.canv.getBoundingClientRect().width,this.outline_canv.getContext("2d")),this.setupListeners()}setupListeners(){this.setupFiguresListeners(),this.setupClearListener(),this.setupFillListener()}setupFillListener(){const t=document.querySelector("#i-color-res");document.querySelector("#cut").addEventListener("click",()=>{try{if(!st(this.ff.chain.getPoints()))throw new Error("Отсекатель не выпуклый или имеет менее трёх точек");let e=ht(this.ff.chain.getPoints(),this.ff.lines);console.log(e),this.graphics.drawLines(e,t.value)}catch(e){J(e)}})}setupClearListener(){document.querySelector("#clear").addEventListener("click",()=>{this.ff.clear()})}setupFiguresListeners(){this.docff.addEventListener("figure_changed",t=>{t.stopPropagation(),this.update()}),this.ff.chain.node.addEventListener("figure_changed",t=>{t.stopPropagation(),this.update()})}update(){const t=document.querySelector("#i-color-rect"),e=document.querySelector("#i-color-line");this.graphics.resetImage();try{this.graphics.drawChain(this.ff.chain,t.value)}catch(s){console.log(s)}try{this.graphics.drawLines(this.ff.lines,e.value)}catch(s){console.log(s)}}reqCanvasCoords(t){return new Promise(e=>{if(this.state!=="idle")throw new Error(`Приложение занято. Текущее состояние: ${this.state}`);this.toggleInterface(!1,t),this.state="picking";let s=a=>{n(),e(j(this.outline_canv,a))},r=a=>{throw a.preventDefault(),n(),new Error("Rightclick")};this.outline_canv.addEventListener("click",s),this.outline_canv.addEventListener("contextmenu",r);let n=()=>{this.outline_canv.removeEventListener("click",s),this.outline_canv.removeEventListener("contextmenu",r),this.state="idle",this.toggleInterface(!0)}})}toggleInterface(t,e){t?(this.blocker.classList.remove("active"),this.blockertext.innerText=""):(this.blocker.classList.add("active"),this.blockertext.innerText=e!==void 0?e:"")}}new lt;
