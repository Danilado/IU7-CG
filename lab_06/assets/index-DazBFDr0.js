var D=Object.defineProperty;var $=(i,e,t)=>e in i?D(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>($(i,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const h of l.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function t(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(n){if(n.ep)return;n.ep=!0;const l=t(n);fetch(n.href,l)}})();class c{constructor(e,t){a(this,"x");a(this,"y");e===void 0?(this.x=0,this.y=0):e instanceof c?(this.x=e.x,this.y=e.y):typeof e=="number"?(this.x=e,this.y=t||0):(this.x=parseFloat(e[0]),this.y=parseFloat(e[1]))}toString(){return`${this.x} ${this.y}`}collinear(e,t){return w((this.y-e.y)*(this.x-t.x)-(this.y-t.y)*(this.x-e.x))<E}equalTo(e){return w(e.x-this.x)<E&&w(e.y-this.y)<E}}const k=Math,x=k.floor,S=k.round,w=k.abs,E=1e-6,F=i=>new Promise(e=>setTimeout(e,i)),B=(i,e)=>{let t=i.getBoundingClientRect();return new c(S(e.clientX-t.left),S(e.clientY-t.top))};class U{constructor(e){a(this,"node");this.node=e}write(e,t){this.node.innerHTML+=t+e.replace(/\n/,"<br />")+"<br />",this.scrollToBottom()}clear(){this.node.innerHTML=""}warn(e){}log(e){}error(e){this.write(e,"ERROR: ")}scrollToBottom(){this.node.scroll(0,this.node.scrollHeight)}}const W=document.querySelector(".footertext"),v=new U(W);function y(i,e){return i===void 0!=(e===void 0)?!1:i.r===e.r&&i.g===e.g&&i.b===e.b}function N(i){return parseInt(i,16)}function A(i){return i=i.replace(/#/,""),{r:N(i[0]+i[1]),g:N(i[2]+i[3]),b:N(i[4]+i[5])}}function b(i,e){if(e.x<0||e.x>=i.width||e.y<0||e.y>=i.height)return;let t=(e.x+e.y*i.width)*4;i.data[t]=e.r,i.data[t+1]=e.g,i.data[t+2]=e.b,i.data[t+3]=e.alpha}function _(i,e,t){if(e<0||e>=i.width||t<0||t>=i.height)return;let r=(e+t*i.width)*4;return{r:i.data[r],g:i.data[r+1],b:i.data[r+2]}}function R(i,e){return{x:2*e-i.x,y:i.y,r:i.r,g:i.g,b:i.b,alpha:i.alpha}}function P(i,e){return{x:i.x,y:2*e-i.y,r:i.r,g:i.g,b:i.b,alpha:i.alpha}}function I(i,e,t){b(i,e),b(i,P(e,t.y)),b(i,R(e,t.x)),b(i,P(R(e,t.x),t.y))}class O{static build(){let e=this.buildMain(),t=this.buildTexinput(e);t.placeholder="x",t.id="x";let r=this.buildTexinput(e);r.placeholder="y",r.id="y";let n=this.buildBtn(e);return n.value="⨯",n.id="del",e}static buildMain(){let e=document.createElement("div");return e.classList.add("row"),e}static buildTexinput(e){let t=document.createElement("input");return t.type="text",t.classList.add("texinput"),e.appendChild(t),t}static buildBtn(e){let t=document.createElement("input");return t.type="button",t.classList.add("button"),e.appendChild(t),t}}class H{constructor(e,t){a(this,"node");a(this,"data");a(this,"x_i");a(this,"y_i");a(this,"del_btn");this.node=O.build(),e.appendChild(this.node),this.data={node:this.node,metadata:t},this.x_i=this.node.querySelector("#x"),this.y_i=this.node.querySelector("#y"),this.del_btn=this.node.querySelector("#del"),this.setupListeners()}setupListeners(){this.setupDeleteListener(),this.setupChangeListeners()}setupDeleteListener(){this.del_btn.addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("point_delete",{bubbles:!0,detail:this.data}))})}setupChangeListeners(){this.x_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))}),this.y_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))})}set x(e){this.x_i.value=`${e}`}set y(e){this.y_i.value=`${e}`}set pt(e){this.x_i.value=`${e.x}`,this.y_i.value=`${e.y}`}get x(){let e=Number(this.x_i.value);return Number.isNaN(e)?0:e}get y(){let e=Number(this.y_i.value);return Number.isNaN(e)?0:e}get pt(){let e=Number(this.x_i.value);Number.isNaN(e)&&(e=0);let t=Number(this.y_i.value);return Number.isNaN(t)&&(t=0),new c(e,t)}validate(){let e=Number(this.x_i.value);if(Number.isNaN(e))throw new Error(`Ошибка в значении координаты x поля ввода с данными ${this.data}`);let t=Number(this.y_i.value);if(Number.isNaN(t))throw new Error(`Ошибка в значении координаты y поля ввода с данными ${this.data}`)}}function z(i,e,t,r,n,l,h=!1){if(h||v.log("Работает Алгоритм Брезенхема на действ. числах"),e==r&&t==n)return b(i,{x:e,y:t,r:l.r,g:l.g,b:l.b,alpha:255});let s=e,p=t,o=r-e,u=n-t,g=Math.sign(o),f=Math.sign(u);o=w(o),u=w(u);let d=!1;if(u>o){d=!0;let L=o;o=u,u=L}let q=u/o,C=q-.5;for(let L=0;L<o;++L)h||b(i,{x:s,y:p,r:l.r,g:l.g,b:l.b,alpha:255}),C>=0&&(d?s+=g:p+=f,C-=1),d?p+=f:s+=g,C+=q}class V{static build(){let e=this.buildMain(),t=this.buildVerbal(e),r=this.buildRow(t);r.innerHTML='<div style="margin-left: auto">Ломаная</div>',r.id="name";let n=this.buildBtn(r);n.value="⨯",n.id="del";let l=this.buildPtsHolder(t);l.id="pts_holder";let h=this.buildRow(t),s=this.buildWideBtn(h);s.id="add_pt",s.value="добавить точку";let p=this.buildRow(t),o=this.buildWideBtn(p);o.id="cont",o.value="продолжить кликами";let u=this.buildRow(t),g=this.buildWideBtn(u);return g.id="close",g.value="замкнуть",e}static buildMain(){let e=document.createElement("div");return e.classList.add("figure"),e}static buildVerbal(e){let t=document.createElement("div");return t.classList.add("verbal"),e.appendChild(t),t}static buildRow(e){let t=document.createElement("div");return t.classList.add("row"),e.appendChild(t),t}static buildPtsHolder(e){let t=document.createElement("div");return t.classList.add("verbal"),e.appendChild(t),t}static buildWideBtn(e){let t=document.createElement("input");return e.appendChild(t),t.type="button",t.classList.add("widebutton"),t}static buildBtn(e){let t=document.createElement("input");return t.type="button",t.classList.add("button"),e.appendChild(t),t}}class X{constructor(e,t){a(this,"node");a(this,"points");a(this,"pts_node");a(this,"coordReqCallback");this.node=V.build(),e.appendChild(this.node),this.coordReqCallback=t,this.points=[],this.pts_node=this.node.querySelector("#pts_holder"),this.setupListeners()}setupListeners(){this.setupAddPointListener(),this.setupContListener(),this.setupCloseListener(),this.setupMainListeners(),this.setupDelListener()}setupDelListener(){this.node.querySelector("#del").addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("figure_delete",{bubbles:!0,detail:{fig:this,node:this.node}}))})}setupAddPointListener(){this.node.querySelector("#add_pt").addEventListener("click",()=>{this.points.push(new H(this.pts_node,{}))})}setupContListener(){this.node.querySelector("#cont").addEventListener("click",()=>{let t=!0,r=()=>{this.coordReqCallback(`Последовательно выбирайте точки
ПКМ, чтобы отменить или завершить`).then(n=>{this.addPoint(n),this.dispatchUpdate()},()=>{t=!1}).finally(()=>{t&&r()})};r()})}addPoint(e){let t=new H(this.pts_node,{});t.pt=e,this.points.push(t),this.pts_node.scroll(0,this.pts_node.scrollHeight)}setupCloseListener(){this.node.querySelector("#close").addEventListener("click",()=>{this.addPoint(this.points[0].pt),this.dispatchUpdate()})}setupMainListeners(){this.node.addEventListener("point_delete",e=>{e.stopPropagation(),this.points=this.points.filter(t=>t.node!==e.detail.node),this.pts_node.removeChild(e.detail.node),this.dispatchUpdate()}),this.node.addEventListener("point_change",e=>{e.stopPropagation(),this.dispatchUpdate()})}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}getPoints(){return this.points.map(e=>e.pt)}draw(e){let t=this.getPoints();if(t.length<2)throw new Error("not enough points");for(let r=0;r<t.length-1;++r)z(e,t[r].x,t[r].y,t[r+1].x,t[r+1].y,{r:0,g:0,b:0},!1)}}function G(i,e,t,r,n,l=!1){let h=0,s=r,p=4*(5-r);for(;h<=s;)l||(I(i,{x:e+h,y:t+s,r:n.r,g:n.g,b:n.b,alpha:255},{x:e,y:t}),I(i,{x:e+s,y:t+h,r:n.r,g:n.g,b:n.b,alpha:255},{x:e,y:t})),h++,p>0&&(s--,p-=8*s),p+=8*h+4}class K{static build(){let e=this.buildMain(),t=this.buildVerbal(e),r=this.buildRow(t);r.innerHTML='<div style="margin-left: auto">Окружность</div>',r.id="name";let n=this.buildBtn(r);n.value="⨯",n.id="del";let l=this.buildRow(t),h=this.buildTexinput(l);h.placeholder="x",h.id="x";let s=this.buildTexinput(l);s.placeholder="y",s.id="y";let p=this.buildRow(t),o=this.buildTexinput(p);o.id="rad",o.placeholder="радиус";let u=this.buildRow(t),g=this.buildWideBtn(u);return g.id="inter_center",g.value="задать центр кликом",e}static buildMain(){let e=document.createElement("div");return e.classList.add("figure"),e}static buildVerbal(e){let t=document.createElement("div");return t.classList.add("verbal"),e.appendChild(t),t}static buildRow(e){let t=document.createElement("div");return t.classList.add("row"),e.appendChild(t),t}static buildWideBtn(e){let t=document.createElement("input");return e.appendChild(t),t.type="button",t.classList.add("widebutton"),t}static buildTexinput(e){let t=document.createElement("input");return t.type="text",t.classList.add("texinput"),e.appendChild(t),t}static buildBtn(e){let t=document.createElement("input");return t.type="button",t.classList.add("button"),e.appendChild(t),t}}class Y{constructor(e,t,r,n){a(this,"node");a(this,"_center");a(this,"_r");a(this,"x_i");a(this,"y_i");a(this,"r_i");a(this,"coordReqCallback");this.node=K.build(),e.appendChild(this.node),this.coordReqCallback=t,this.x_i=this.node.querySelector("#x"),this.y_i=this.node.querySelector("#y"),this.r_i=this.node.querySelector("#rad"),this._center=r!==void 0?r:new c(0,0),this._r=n!==void 0?n:0,this.setupListeners()}setupListeners(){this.setupCoordsListeners(),this.setupRadiusListener(),this.setupInterListener(),this.setupDelListener()}setupDelListener(){this.node.querySelector("#del").addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("figure_delete",{bubbles:!0,detail:{fig:this,node:this.node}}))})}setupCoordsListeners(){this.x_i.addEventListener("keyup",()=>{let e=Number(this.x_i.value);Number.isNaN(e)||(this.cx=e)}),this.y_i.addEventListener("keyup",()=>{let e=Number(this.y_i.value);Number.isNaN(e)||(this.cy=e)})}setupRadiusListener(){this.r_i.addEventListener("keyup",()=>{let e=Number(this.r_i.value);Number.isNaN(e)||(this.r=e)})}setupInterListener(){this.node.querySelector("#inter_center").addEventListener("click",()=>{this.coordReqCallback(`Выберите точку центра окружности
ПКМ для отмены`).then(t=>{this.center=t,this.dispatchUpdate()},t=>{v.error(t.message)})})}get center(){return this._center}set center(e){this.cx=e.x,this.cy=e.y,this.x_i.value=`${e.x}`,this.y_i.value=`${e.y}`,this.dispatchUpdate()}get cx(){return this._center.x}set cx(e){this._center=new c(e,this._center.y),this.x_i.value=`${e}`,this.dispatchUpdate()}get cy(){return this._center.y}set cy(e){this._center=new c(this._center.x,e),this.y_i.value=`${e}`,this.dispatchUpdate()}get r(){return this._r}set r(e){this._r=e,this.r_i.value=`${e}`,this.dispatchUpdate()}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}draw(e){G(e,this.cx,this.cy,this.r,{r:0,g:0,b:0},!1)}}class j{constructor(e,t,r,n){a(this,"container");a(this,"figures");a(this,"addChainBtn");a(this,"addCircleBtn");a(this,"coordReqCallback");this.container=e,this.figures=[],this.addChainBtn=t,this.addCircleBtn=r,this.coordReqCallback=n,this.setupListeners()}addChain(){let e=new X(this.container,this.coordReqCallback);return this.figures.push(e),this.container.scroll(0,this.container.scrollHeight),e}removeFigure(e){this.figures=this.figures.filter(t=>t!==e),this.container.removeChild(e.node),this.dispatchUpdate()}clear(){for(this.figures=[];this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.dispatchUpdate()}dispatchUpdate(){this.container.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.container}}))}setupListeners(){this.setupAddChainListener(),this.setupAddCircleListener(),this.setupDelListener()}setupDelListener(){this.container.addEventListener("figure_delete",e=>{e.stopPropagation(),this.removeFigure(e.detail.fig)})}setupAddChainListener(){this.addChainBtn.addEventListener("click",()=>{this.addChain()})}setupAddCircleListener(){this.addCircleBtn.addEventListener("click",()=>{this.figures.push(new Y(this.container,this.coordReqCallback)),this.container.scroll(0,this.container.scrollHeight)})}}const M=document.querySelector(".c-width"),T=document.querySelector(".c-height");function m(i){return i===void 0?!0:!i.r&&!i.g&&!i.b}class J{constructor(e,t,r){a(this,"node");a(this,"out_renderer");a(this,"renderer");a(this,"ctx");a(this,"image");a(this,"ar");a(this,"choosing");a(this,"_width");a(this,"_height");let n=e.canvas.getBoundingClientRect();e.canvas.width=n.width,r.canvas.width=n.width,e.canvas.height=n.height,r.canvas.height=n.height,this.out_renderer=r,this.out_renderer.lineWidth=2,this.renderer=e,this.node=e.canvas,this.renderer.imageSmoothingEnabled=!1,this.ctx=document.createElement("canvas").getContext("2d"),this.ctx.lineWidth=2,this.renderer.lineWidth=2,this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._width=t,this._height=x(this._width/this.ar),this.width=t,this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(255),this.choosing=!1,this.ctx.strokeStyle="black"}get width(){return this._width}set width(e){this._width=e,this._height=x(this._width/this.ar),M.innerHTML=`${this._width}`,T.innerHTML=`${this._height}`,this.resetImage()}get height(){return this._height}set height(e){this._height=x(e),this._width=x(this._height*this.ar),M.innerHTML=`${this._width}`,T.innerHTML=`${this._height}`,this.resetImage()}update(){this.clearCtx(),this.drawImageData()}getBuf(){return this.image}putImageData(e){e instanceof ImageData?(this.image=e,this.update()):e.then(t=>{this.image=t,this.update()},t=>{throw t})}drawImageData(){this.renderer.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.ctx.putImageData(this.image,0,0),this.renderer.drawImage(this.ctx.canvas,0,0,this.width*this.getPixelSize(),x(this.height)*this.getPixelSize())}resizeCtx(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height}clearCtx(){this.ctx.clearRect(0,0,this.width,this.height),this.out_renderer.clearRect(0,0,this.width,this.height)}resetImage(){this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._height=this._width/this.ar,this.resizeCtx(),this.clearCtx(),this.renderer.clearRect(0,0,this.width,this.height),this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(255),this.drawImageData()}getPixelSize(){return this.renderer.canvas.getBoundingClientRect().width/this.width}async fill(e,t,r){let n=performance.now(),l=[e],h=this.getBuf(),s=new c;for(;l.length;){s=l.pop(),b(h,{x:s.x,y:s.y,r:t.r,g:t.g,b:t.b,alpha:255});let o=s.x;for(++s.x;s.x<this.width&&!m(_(h,s.x,s.y));)b(h,{x:s.x,y:s.y,r:t.r,g:t.g,b:t.b,alpha:255}),++s.x;let u=s.x-1;for(s.x=o-1;s.x>=0&&!m(_(h,s.x,s.y));)b(h,{x:s.x,y:s.y,r:t.r,g:t.g,b:t.b,alpha:255}),--s.x;let g=s.x+1;if(s.x=g,++s.y,s.y<this.height)for(;s.x<=u;){let f=!1;for(;s.x<=u;){let d=_(h,s.x,s.y);if(m(d)||y(d,t))break;f=!0,++s.x}if(f){let d=_(h,s.x,s.y);s.x==u&&!y(d,t)&&!m(d)?l.push(new c(s)):l.push(new c(s.x-1,s.y)),f=!1}for(o=s.x;s.x<u;){let d=_(h,s.x,s.y);if(!y(d,t)&&!m(d))break;++s.x}s.x==o&&++s.x}if(s.x=g,s.y-=2,s.y>=0)for(;s.x<=u;){let f=!1;for(;s.x<=u;){let d=_(h,s.x,s.y);if(y(d,t)||m(d))break;f=!0,++s.x}if(f){let d=_(h,s.x,s.y);s.x==u&&!y(d,t)&&!m(d)?l.push(new c(s)):l.push(new c(s.x-1,s.y)),f=!1}for(o=s.x;s.x<u;){let d=_(h,s.x,s.y);if(!y(d,t)&&!m(d))break;++s.x}s.x==o&&++s.x}r&&(this.drawImageData(),await F(r))}return this.drawImageData(),performance.now()-n}async drawFigures(e){this.resetImage();let t=this.getBuf();for(let r of e)try{r.draw(t)}catch(n){console.log(n)}this.drawImageData()}}class Q{constructor(){a(this,"state","idle");a(this,"ff");a(this,"graphics");a(this,"blocker");a(this,"blockertext");a(this,"docff");a(this,"canv");a(this,"outline_canv");a(this,"delay_i");a(this,"color_i");a(this,"fillx");a(this,"filly");this.docff=document.querySelector("#figures"),this.ff=new j(this.docff,document.querySelector("#add_line"),document.querySelector("#add_circle"),e=>this.reqCanvasCoords(e)),this.blocker=document.querySelector(".blocker"),this.blockertext=document.querySelector(".blockertext"),this.canv=document.querySelector("#main_canvas"),this.outline_canv=document.querySelector("#outline_canvas"),this.fillx=document.querySelector("#fillx"),this.filly=document.querySelector("#filly"),this.graphics=new J(this.canv.getContext("2d"),this.canv.getBoundingClientRect().width,this.outline_canv.getContext("2d")),this.delay_i=document.querySelector("#delay"),this.color_i=document.querySelector("#i-color"),this.setupListeners()}setupListeners(){this.setupFiguresListeners(),this.setupDrawListeners(),this.setupClearListener(),this.setupFillListener()}setupFillListener(){document.querySelector("#fill").addEventListener("click",()=>{let e=Number(this.delay_i.value),t=Number(this.fillx.value);if(this.fillx.value==""&&(t=-1),Number.isNaN(t))return v.error("Ошибка ввода координаты x затравки");let r=Number(this.filly.value);if(this.filly.value==""&&(t=-1),Number.isNaN(r))return v.error("Ошибка ввода координаты y затравки");if(this.delay_i.value==""&&(e=0),Number.isNaN(e))return v.error("Ошибка ввода задержки при заливке");t<0?this.reqCanvasCoords(`Выберите точку затравки
ПКМ для отмены`).then(n=>{this.fillHelper(n,e)},n=>{v.error(n.message)}):this.fillHelper(new c(t,r),e)})}fillHelper(e,t){this.state="filling",this.toggleInterface(!1,"Выполняется заливка"),this.graphics.fill(e,A(this.color_i.value),t).then(r=>{let n=r>1e3;r>1e3&&(r/=1e3),v.write(`Заливка заняла ${r}${n?"c":"мс"}`,"")},r=>{v.error(r)}).finally(()=>{this.toggleInterface(!0),this.state="idle"})}setupClearListener(){document.querySelector("#clear").addEventListener("click",()=>{this.ff.clear()})}setupFiguresListeners(){this.docff.addEventListener("figure_changed",e=>{e.stopPropagation(),this.update()})}update(){this.graphics.drawFigures(this.ff.figures)}reqCanvasCoords(e){return new Promise(t=>{if(this.state!=="idle")throw new Error(`Приложение занято. Текущее состояние: ${this.state}`);this.toggleInterface(!1,e),this.state="picking";let r=h=>{l(),t(B(this.outline_canv,h))},n=h=>{throw h.preventDefault(),l(),new Error("Rightclick")};this.outline_canv.addEventListener("click",r),this.outline_canv.addEventListener("contextmenu",n);let l=()=>{this.outline_canv.removeEventListener("click",r),this.outline_canv.removeEventListener("contextmenu",n),this.state="idle",this.toggleInterface(!0)}})}setupDrawListeners(){let e;this.outline_canv.addEventListener("mousedown",()=>{this.state==="idle"&&(this.state="drawing",e=this.ff.addChain())}),this.outline_canv.addEventListener("mouseup",()=>{this.state==="drawing"&&(this.state="idle",e.points.length<2&&this.ff.removeFigure(e),e=void 0)}),this.outline_canv.addEventListener("mousemove",t=>{if(this.state!=="drawing")return;let r=B(this.outline_canv,t);e.addPoint(r),this.update()}),this.outline_canv.addEventListener("mouseleave",()=>{this.state==="drawing"&&(this.state="idle",e.points.length<2&&this.ff.removeFigure(e),e=void 0)})}toggleInterface(e,t){e?(this.blocker.classList.remove("active"),this.blockertext.innerText=""):(this.blocker.classList.add("active"),this.blockertext.innerText=t!==void 0?t:"")}}new Q;
