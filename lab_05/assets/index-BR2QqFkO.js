var E=Object.defineProperty;var B=(r,t,e)=>t in r?E(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>(B(r,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const h of s)if(h.type==="childList")for(const o of h.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const h={};return s.integrity&&(h.integrity=s.integrity),s.referrerPolicy&&(h.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?h.credentials="include":s.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function i(s){if(s.ep)return;s.ep=!0;const h=e(s);fetch(s.href,h)}})();const u=Math,l=u.floor,f=u.round,v=u.min,m=u.max,c=u.abs;function x(r){return parseInt(r,16)}function T(r){return r=r.replace(/#/,""),{r:x(r[0]+r[1]),g:x(r[2]+r[3]),b:x(r[4]+r[5])}}function I(r,t){if(t.x<0||t.x>=r.width||t.y<0||t.y>=r.height)return;let e=(t.x+t.y*r.width)*4;r.data[e]^=t.r,r.data[e+1]^=t.g,r.data[e+2]^=t.b,r.data[e+3]^=t.alpha}const w=1e-6,R=r=>new Promise(t=>setTimeout(t,r));class y{constructor(t,e){n(this,"x");n(this,"y");t===void 0?(this.x=0,this.y=0):typeof t=="number"?(this.x=t,this.y=e||0):(this.x=parseFloat(t[0]),this.y=parseFloat(t[1]))}toString(){return`${this.x} ${this.y}`}collinear(t,e){return c((this.y-t.y)*(this.x-e.x)-(this.y-e.y)*(this.x-t.x))<w}equalTo(t){return c(t.x-this.x)<w&&c(t.y-this.y)<w}}class S{constructor(t,e=[]){n(this,"context");n(this,"points");n(this,"color",{r:0,g:0,b:0});this.context=t,this.points=e}addNode(t){(!this.points.length||!t.equalTo(this.points[this.points.length-1]))&&this.points.push(t)}drawEdges(){if(this.points.length<3)throw new Error("Недостаточно точек для отрисовки многоугольника. Введите хотя бы три.");let t=this.context.out_renderer;t.beginPath();let e;for(let i of this.points)e===void 0?(t.moveTo(i.x,i.y+.5),e=i):t.lineTo(i.x,i.y+.5);t.lineTo(e.x,e.y+.5),t.stroke(),t.closePath()}drawHelpful(t){if(this.points.length===0)return;let e=this.context.out_renderer;e.beginPath();let i;for(let s of this.points)i===void 0?(e.moveTo(s.x,s.y+.5),i=s):e.lineTo(s.x,s.y+.5);e.lineTo(t.x,t.y),e.stroke(),e.closePath(),e.beginPath(),e.save(),e.strokeStyle="blue",e.setLineDash([20,5]),e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.stroke(),e.restore(),e.closePath()}checkOneLine(){if(this.points.length<3)throw new Error("Недостаточно точек");let t=this.points[0],e=this.points[1];if(this.points.every(i=>i.collinear(t,e)))throw new Error("Все точки лежат на одной прямой")}async fill(t){return new Promise((i,s)=>{this.points.length<3&&s(new Error("Недостаточно точек")),this.checkOneLine();let h=this.getBorders();this.xorFillSep(h,t).then(o=>i(o),o=>s(o))})}getBoundaries(){if(this.points.length===0)return{x1:0,y1:0,x2:0,y2:0};let t={x1:1/0,y1:1/0,x2:0,y2:0};for(let e of this.points)t.x1=v(t.x1,e.x),t.x2=m(t.x2,e.x),t.y1=v(t.y1,e.y),t.y2=m(t.y2,e.y);return t}getBorder(t,e){let i=[];if(t.y==e.y)return t.x==e.x?[new y(t.x,t.y)]:[];let s=m(c(e.x-t.x),c(e.y-t.y)),h=(e.x-t.x)/s,o=(e.y-t.y)/s,d=t.x,g=t.y;for(let p=0;p<=s;++p)i.push(new y(f(d),f(g))),d+=h,g+=o;return i}getBorders(){if(this.points.length<3)throw Error("Недостаточно точек для закраски многоугольника");let t=[];for(let e=0;e<=this.points.length;++e)t.push([]);for(let e=0;e<this.points.length-1;++e)t[e]=this.getBorder(this.points[e],this.points[e+1]);return t[t.length-1]=this.getBorder(this.points[this.points.length-1],this.points[0]),t}getSeparator(t){return t.length?t.reduce((i,s)=>i+s.reduce((h,o)=>h+o.x,0),0)/t.reduce((i,s)=>i+s.length,0):0}thinBorderSep(t,e){if(!t.length)return[];let i=[];if(e!==void 0&&e==t[0].y<t[t.length-1].y){let o=t[0].y;for(;t.length&&t[0].y==o;)t.shift()}if(!t.length)return[];let s=t[0],h=t[0].y;for(let o of t)o.y==h?s.x<o.x&&(s=o):(i.push(s),h=o.y,s=o);return(!i.length||i[i.length-1].y!=s.y)&&i.push(s),i}thinBordersSep(t){var s,h;let e=[],i=((s=t[t.length-1][0])==null?void 0:s.y)<((h=t[t.length-1][t[t.length-1].length-1])==null?void 0:h.y);for(let o of t)o.length&&(o=this.thinBorderSep(o,i),o.length>1&&(i=o[0].y<o[o.length-1].y),e.push(o));return e}async xorFillSep(t,e){let i=this.context.getBuf(),s=this.getSeparator(t);return t=this.thinBordersSep(t),new Promise(async o=>{let d=performance.now();for(let p of t)for(let C of p)this.xorFillLine(i,s,C),e&&(this.context.putImageData(i),await R(e));let g=performance.now();e||this.context.putImageData(i),o(g-d)})}xorFillLine(t,e,i){if(e<i.x)for(let s=i.x;s>e;--s)I(t,{x:s,y:i.y,r:this.color.r,g:this.color.g,b:this.color.b,alpha:255});else for(let s=i.x;s<=e;++s)I(t,{x:s,y:i.y,r:this.color.r,g:this.color.g,b:this.color.b,alpha:255})}clear(){this.points=[]}toString(){return this.points.map(t=>t.toString()).join(`
`)}setColor(t){this.color=t}}const L=document.querySelector(".c-width"),P=document.querySelector(".c-height");class q{constructor(t,e,i){n(this,"node");n(this,"out_renderer");n(this,"renderer");n(this,"ctx");n(this,"image");n(this,"ar");n(this,"choosing");n(this,"polygon");n(this,"_width");n(this,"_height");this.out_renderer=i,this.out_renderer.lineWidth=2,this.renderer=t,this.node=t.canvas,this.renderer.imageSmoothingEnabled=!1,this.ctx=document.createElement("canvas").getContext("2d"),this.ctx.lineWidth=2,this.renderer.lineWidth=2,this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._width=e,this._height=l(this._width/this.ar),this.width=e,this.image=this.ctx.createImageData(this.width,this.height),this.choosing=!1,this.polygon=new S(this),this.ctx.strokeStyle="black"}get width(){return this._width}set width(t){this._width=t,this._height=l(this._width/this.ar),L.innerHTML=`${this._width}`,P.innerHTML=`${this._height}`,this.resetImage()}get height(){return this._height}set height(t){this._height=l(t),this._width=l(this._height*this.ar),L.innerHTML=`${this._width}`,P.innerHTML=`${this._height}`,this.resetImage()}update(){this.clearCtx(),this.drawImageData(),this.polygon.drawEdges()}getBuf(){return this.image}putImageData(t){t instanceof ImageData?(this.image=t,this.update()):t.then(e=>{this.image=e,this.update()},e=>{throw e})}drawImageData(){this.renderer.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.ctx.putImageData(this.image,0,0),this.renderer.drawImage(this.ctx.canvas,0,0,this.width*this.getPixelSize(),l(this.height)*this.getPixelSize())}resizeCtx(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height}clearCtx(){this.ctx.clearRect(0,0,this.width,this.height),this.out_renderer.clearRect(0,0,this.width,this.height)}resetImage(){this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._height=this._width/this.ar,this.resizeCtx(),this.clearCtx(),this.renderer.clearRect(0,0,this.width,this.height),this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(0),this.drawImageData()}getPixelSize(){return this.renderer.canvas.getBoundingClientRect().width/this.width}async fill(t){return this.image&&this.image.data.fill(0),this.polygon.fill(t)}}class H{constructor(t,e,i){n(this,"node");n(this,"gr");n(this,"textArea");this.node=t,this.gr=e,this.textArea=i,this.setup()}setup(){this.node.addEventListener("click",()=>{this.gr.polygon.clear(),this.gr.resetImage(),this.textArea.node.value=""})}}class F{constructor(t){n(this,"node");this.node=t}write(t,e){this.node.innerHTML+=e+t.replace(/\n/,"<br />")+"<br />",this.scrollToBottom()}clear(){this.node.innerHTML=""}warn(t){}log(t){}error(t){this.write(t,"ERROR: ")}scrollToBottom(){this.node.scroll(0,this.node.scrollHeight)}}const N=document.querySelector(".footertext"),_=new F(N);class D{constructor(t,e,i){n(this,"node");n(this,"gr");n(this,"parent");this.node=t,this.gr=e,this.parent=i,this.setup()}setup(){this.node.addEventListener("click",()=>{try{this.gr.polygon.color=T(this.parent.color)}catch(t){_.error(`${t}`)}this.gr.fill(this.parent.delay).then(t=>{let e=t>1e3;t>1e3&&(t/=1e3),_.write(`Закраска заняла ${t}${e?"c":"мс"}`,"")},t=>_.error(`${t}`))})}}class M{constructor(t,e){n(this,"_canvas");n(this,"canvas_gr");n(this,"parent");this.canvas_gr=t,this.parent=e,this._canvas=t.node,this.setupGraphicsListener()}addPointListner(t){let e=this.canvas_gr;e.choosing?(e.clearCtx(),e.polygon.addNode(a.getPtFromEvent(e.node,t)),e.polygon.drawHelpful(a.getPtFromEvent(e.node,t)),this.parent.setPointsValue(e.polygon.toString())):(e.choosing=!0,e.clearCtx(),e.polygon.drawHelpful(a.getPtFromEvent(e.node,t)))}closePathListener(){let t=this.canvas_gr;t.clearCtx(),t.choosing=!1,t.update()}mouseMoveListener(t){let e=this.canvas_gr;e.choosing&&(e.clearCtx(),e.polygon.drawHelpful(a.getPtFromEvent(e.node,t)))}setupGraphicsListener(){this._canvas.addEventListener("click",t=>{this.addPointListner(t)}),this._canvas.addEventListener("contextmenu",t=>{t.preventDefault(),this.closePathListener()}),this._canvas.addEventListener("mousemove",t=>{this.mouseMoveListener(t)})}}class O{constructor(t){n(this,"node");this.node=t}validateInput(){return this.node.value.trim().split(`
`).every(t=>t.trim().split(" ").length==2)}value(){return this.node.value.trim().split(`
`).map(t=>new y(t.trim().split(" ")))}}class ${constructor(t,e){n(this,"_points");n(this,"parent");n(this,"points_i");this._points=t,this.points_i=new O(t),this.parent=e,this.setupTAPI()}setupTAPI(){this._points.addEventListener("keyup",()=>{this.points_i.validateInput()&&(this.parent.setCanvPoly(this.points_i.value()),this.parent.updateCanv())})}}class b{constructor(t){n(this,"node");this.node=t}validateInput(t=-1/0,e=1/0){if(this.node.value=="")return!1;let i=Number(this.node.value);return!(Number.isNaN(i)||i<t||i>e)}value(t=-1/0,e=1/0){if(this.node.value=="")return 0;let i=Number(this.node.value);return Number.isNaN(i)?i:i<t?t:i>e?e:i}}class k{constructor(t){n(this,"node");this.node=t}validateInput(){return CSS.supports("color",this.node.value)}value(){return this.node.value}}class a{constructor(t,e,i,s,h,o){n(this,"_color");n(this,"_points");n(this,"gr");n(this,"color_i");n(this,"points_i");n(this,"delay_i");n(this,"canv_listeners");n(this,"pts_listeners");n(this,"clean_listener");n(this,"fill_listener");this._color=t,this.color_i=new k(t),this.delay_i=new b(i),this._points=e,this.pts_listeners=new $(e,this),this.points_i=this.pts_listeners.points_i,this.gr=o,this.canv_listeners=new M(o,this),this.clean_listener=new H(s,this.gr,this.points_i),this.fill_listener=new D(h,this.gr,this),this._color}static getPtFromEvent(t,e){let i=t.getBoundingClientRect();return new y(f(e.clientX-i.x),f(e.clientY-i.y))}updateCanv(){this.gr.update()}setCanvPoly(t){this.gr.polygon=new S(this.gr,t),this.gr.update()}setPointsValue(t){this._points.value=t,this._points.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0}))}get color(){if(!this.color_i.validateInput())throw new Error("Ошибка выбора цвета");return this.color_i.value()}get points(){if(!this.points_i.validateInput())throw new Error("Ошибка ввода точек");return this.points_i.value()}get delay(){if(!this.delay_i.validateInput())throw new Error("Ошибка ввода задержки");return this.delay_i.value()}}const A=document.querySelector("#i-color"),z=document.querySelector("textarea"),G=document.querySelector("#delay"),W=document.querySelector("#fill"),X=document.querySelector("#clear");document.querySelector("#set_width");function K(r){return new a(A,z,G,X,W,r)}class V{constructor(t,e){n(this,"graphics");n(this,"controls");t.width=t.getBoundingClientRect().width,t.height=t.getBoundingClientRect().height,e.width=t.width,e.height=t.height,this.graphics=new q(t.getContext("2d"),t.getBoundingClientRect().width,e.getContext("2d")),this.controls=K(this.graphics),console.log(this.controls.points)}}const Y=document.querySelector("canvas"),j=document.querySelector("#outline_canvas");new V(Y,j);
