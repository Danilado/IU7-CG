var X=Object.defineProperty;var G=(i,t,e)=>t in i?X(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var h=(i,t,e)=>(G(i,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class o{constructor(t,e){h(this,"x");h(this,"y");t===void 0?(this.x=0,this.y=0):t instanceof o?(this.x=t.x,this.y=t.y):typeof t=="number"?(this.x=t,this.y=e||0):(this.x=parseFloat(t[0]),this.y=parseFloat(t[1]))}toString(){return`${this.x} ${this.y}`}collinear(t,e){return m((this.y-t.y)*(this.x-e.x)-(this.y-e.y)*(this.x-t.x))<q}equalTo(t){return m(t.x-this.x)<q&&m(t.y-this.y)<q}}class Y{constructor(t){h(this,"node");this.node=t}write(t,e){this.node.innerHTML+=e+t.replace(/\n/,"<br />")+"<br />",this.scrollToBottom()}clear(){this.node.innerHTML=""}warn(t){}log(t){}error(t){this.write(t,"ERROR: ")}scrollToBottom(){this.node.scroll(0,this.node.scrollHeight)}}const K=document.querySelector(".footertext"),D=new Y(K),R=Math,b=R.floor,k=R.round,$=R.min,F=R.max,m=R.abs,q=1e-6,j=(i,t)=>{let e=i.getBoundingClientRect();return new o(k(t.clientX-e.left),k(t.clientY-e.top))};function J(i){i instanceof Error?D.error(i.message):D.error(`${i}`)}function M(i){return parseInt(i,16)}function T(i){return i=i.replace(/#/,""),{r:M(i[0]+i[1]),g:M(i[2]+i[3]),b:M(i[4]+i[5])}}function x(i,t){if(t.x<0||t.x>=i.width||t.y<0||t.y>=i.height)return;let e=(t.x+t.y*i.width)*4;i.data[e]=t.r,i.data[e+1]=t.g,i.data[e+2]=t.b,i.data[e+3]=t.alpha}function S(i,t){if(t.x<0||t.x>=i.width||t.y<0||t.y>=i.height)return;let e=(t.x+t.y*i.width)*4,r=i.data[e],s=i.data[e+1],n=i.data[e+2],a=i.data[e+3];i.data[e]=t.r*t.alpha/255+r*a*(255-t.alpha)/(255*255),i.data[e+1]=t.g*t.alpha/255+s*a*(255-t.alpha)/(255*255),i.data[e+2]=t.b*t.alpha/255+n*a*(255-t.alpha)/(255*255),i.data[e+3]=t.alpha+a*(255-t.alpha)/255}function E(i){return i-b(i)}function L(i){return 1-E(i)}function N(i,t,e,r,s,n,a=!1){if(a||D.log("Работает Алгоритм Ву"),m(t-r)<q&&m(e-s)<q)return x(i,{x:k(t),y:k(e),r:n.r,g:n.g,b:n.b,alpha:255});let g=m(s-e)>m(r-t);if(g){let u=t;t=e,e=u,u=r,r=s,s=u}if(t>r){let u=t;t=r,r=u,u=s,s=e,e=u}let _=r-t,C=s-e,d;m(_)<q?d=1:d=C/_;let p=k(t),c=e+d*(p-t),f=L(t+.5),w=p,v=b(c);g?(S(i,{x:v,y:w,r:n.r,g:n.g,b:n.b,alpha:L(c)*f*255}),S(i,{x:v+1,y:w,r:n.r,g:n.g,b:n.b,alpha:E(c)*f*255})):(S(i,{x:w,y:v,r:n.r,g:n.g,b:n.b,alpha:L(c)*f*255}),S(i,{x:w,y:v+1,r:n.r,g:n.g,b:n.b,alpha:E(c)*f*255}));let y=c+d;p=k(r),c=s+d*(p-r),f=L(r+.5);let l=p,B=b(c);g?(x(i,{x:B,y:l,r:n.r,g:n.g,b:n.b,alpha:L(c)*f*255}),x(i,{x:B+1,y:l,r:n.r,g:n.g,b:n.b,alpha:E(c)*f*255})):(x(i,{x:l,y:B,r:n.r,g:n.g,b:n.b,alpha:L(c)*f*255}),x(i,{x:l,y:B+1,r:n.r,g:n.g,b:n.b,alpha:E(c)*f*255}));let H=Math.sign(l-w);if(g)for(let u=w+1;u!=l;u+=H)x(i,{x:b(y),y:u,r:n.r,g:n.g,b:n.b,alpha:L(y)*255}),x(i,{x:b(y)+1,y:u,r:n.r,g:n.g,b:n.b,alpha:E(y)*255}),y+=d;else for(let u=w+1;u!=l;u+=H)x(i,{x:u,y:b(y),r:n.r,g:n.g,b:n.b,alpha:L(y)*255}),x(i,{x:u,y:b(y)+1,r:n.r,g:n.g,b:n.b,alpha:E(y)*255}),y+=d}class Q{static build(t){let e=this.buildMain(),r=this.buildTexinput(e);r.placeholder="x",r.id="x";let s=this.buildTexinput(e);if(s.placeholder="y",s.id="y",t!==!0){let n=this.buildBtn(e);n.value="⨯",n.id="del"}return e}static buildMain(){let t=document.createElement("div");return t.classList.add("row"),t}static buildTexinput(t){let e=document.createElement("input");return e.type="text",e.classList.add("texinput"),t.appendChild(e),e}static buildBtn(t){let e=document.createElement("input");return e.type="button",e.classList.add("button"),t.appendChild(e),e}}class P{constructor(t,e,r){h(this,"node");h(this,"data");h(this,"x_i");h(this,"y_i");h(this,"del_btn");this.node=Q.build(r),t.appendChild(this.node),this.data={node:this.node,metadata:e},this.x_i=this.node.querySelector("#x"),this.y_i=this.node.querySelector("#y"),this.del_btn=this.node.querySelector("#del"),this.setupListeners()}setupListeners(){this.del_btn!==null&&this.setupDeleteListener(),this.setupChangeListeners()}setupDeleteListener(){this.del_btn.addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("point_delete",{bubbles:!0,detail:this.data}))})}setupChangeListeners(){this.x_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))}),this.y_i.addEventListener("keyup",()=>{this.node.dispatchEvent(new CustomEvent("point_change",{bubbles:!0,detail:this.data}))})}set x(t){this.x_i.value=`${t}`}set y(t){this.y_i.value=`${t}`}set pt(t){this.x_i.value=`${t.x}`,this.y_i.value=`${t.y}`}get x(){let t=Number(this.x_i.value);return Number.isNaN(t)?0:t}get y(){let t=Number(this.y_i.value);return Number.isNaN(t)?0:t}get pt(){let t=Number(this.x_i.value);Number.isNaN(t)&&(t=0);let e=Number(this.y_i.value);return Number.isNaN(e)&&(e=0),new o(t,e)}validate(){let t=Number(this.x_i.value);if(Number.isNaN(t)||this.x_i.value==="")throw new Error(`Ошибка в значении координаты x поля ввода с данными ${this.data}`);let e=Number(this.y_i.value);if(Number.isNaN(e)||this.y_i.value==="")throw new Error(`Ошибка в значении координаты y поля ввода с данными ${this.data}`)}}class Z{static build(){let t=this.buildMain(),e=this.buildVerbal(t),r=this.buildRow(e);r.innerHTML='<div style="margin-left: auto">Отрезок</div>',r.id="name";let s=this.buildBtn(r);s.value="⨯",s.id="del";let n=this.buildPtsHolder(e);n.id="pts_holder";let a=this.buildRow(e),g=this.buildWideBtn(a);return g.id="inter",g.value="задать кликами",t}static buildMain(){let t=document.createElement("div");return t.classList.add("figure"),t}static buildVerbal(t){let e=document.createElement("div");return e.classList.add("verbal"),t.appendChild(e),e}static buildRow(t){let e=document.createElement("div");return e.classList.add("row"),t.appendChild(e),e}static buildPtsHolder(t){let e=document.createElement("div");return e.classList.add("verbal"),e.classList.add("high"),t.appendChild(e),e}static buildWideBtn(t){let e=document.createElement("input");return t.appendChild(e),e.type="button",e.classList.add("widebutton"),e}static buildBtn(t){let e=document.createElement("input");return e.type="button",e.classList.add("button"),t.appendChild(e),e}}class z{constructor(t,e){h(this,"node");h(this,"_pt1");h(this,"_pt2");h(this,"pts_node");h(this,"coordReqCallback");this.node=Z.build(),t.appendChild(this.node),this.coordReqCallback=e,this.pts_node=this.node.querySelector("#pts_holder"),this._pt1=new P(this.pts_node,{},!0),this._pt2=new P(this.pts_node,{},!0),this.setupListeners()}setupListeners(){this.setupInterListener(),this.setupMainListeners(),this.setupDelListener()}setupDelListener(){this.node.querySelector("#del").addEventListener("click",()=>{this.node.dispatchEvent(new CustomEvent("figure_delete",{bubbles:!0,detail:{fig:this,node:this.node}}))})}setupInterListener(){this.node.querySelector("#inter").addEventListener("click",()=>{this.coordReqCallback(`Выберите первую точку отрезка
Или нажмите ПКМ для отмены`).then(e=>{this.coordReqCallback(`Выберите вторую точку отрезка
Или нажмите ПКМ для отмены`).then(r=>{this.pt1=e,this.pt2=r,this.dispatchUpdate()})})})}setupMainListeners(){this.node.addEventListener("point_change",t=>{t.stopPropagation(),this.dispatchUpdate()})}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}draw(t,e){try{this._pt1.validate()}catch{throw new Error("Ошибка ввода первой точки отрезка")}try{this._pt2.validate()}catch{throw new Error("Ошибка ввода первой точки отрезка")}N(t,this.x1,this.y1,this.x2,this.y2,e,!1)}get pt1(){return this._pt1.pt}set pt1(t){this._pt1.pt=t}get pt2(){return this._pt2.pt}set pt2(t){this._pt2.pt=t}get x1(){return this._pt1.x}set x1(t){this._pt1.x=t}get y1(){return this._pt1.y}set y1(t){this._pt1.y=t}get x2(){return this._pt2.x}set x2(t){this._pt2.x=t}get y2(){return this._pt2.y}set y2(t){this._pt2.y=t}}class tt{static build(){let t=this.buildMain(),e=this.buildButton();return t.appendChild(e),t}static buildMain(){let t=document.createElement("div");return t.classList.add("row"),t}static buildButton(){let t=document.createElement("input");return t.type="button",t.classList.add("widebutton"),t.value="Задать кликами",t}}class A{constructor(t,e){h(this,"coordReqCallback");h(this,"node");h(this,"_pt1");h(this,"_pt2");h(this,"inter_set_btn");this.node=t,this._pt1=new P(this.node,{},!0),this._pt2=new P(this.node,{},!0);let r=tt.build();this.node.appendChild(r),this.inter_set_btn=r.querySelector("input"),this.coordReqCallback=e,this.setupListeners()}setupListeners(){this.setupInterSetBtnListeners(),this.setupRectListener()}setupRectListener(){this.node.addEventListener("point_change",t=>{t.stopPropagation(),this.dispatchUpdate()})}setupInterSetBtnListeners(){this.inter_set_btn.addEventListener("click",()=>{this.coordReqCallback(`Выберите первый угол отсекателя
Или нажмите ПКМ для отмены`).then(t=>{this.coordReqCallback(`Выберите второй угол отсекателя
Или нажмите ПКМ для отмены`).then(e=>{this.pt1=t,this.pt2=e,this.dispatchUpdate()})})})}draw(t,e){try{this._pt1.validate()}catch{throw new Error("Ошибка ввода первого угла отсекателя")}try{this._pt2.validate()}catch{throw new Error("Ошибка ввода второго угла отсекателя")}let r=[this.pt1,new o(this.pt1.x,this.pt2.y),this.pt2,new o(this.pt2.x,this.pt1.y),this.pt1];if(r.length<2)throw new Error("not enough points");for(let s=0;s<r.length-1;++s)N(t,r[s].x,r[s].y,r[s+1].x,r[s+1].y,e,!1)}dispatchUpdate(){this.node.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.node}}))}get pt1(){return this._pt1.pt}set pt1(t){this._pt1.pt=t}get pt2(){return this._pt2.pt}set pt2(t){this._pt2.pt=t}get x1(){return this._pt1.x}set x1(t){this._pt1.x=t}get y1(){return this._pt1.y}set y1(t){this._pt1.y=t}get x2(){return this._pt2.x}set x2(t){this._pt2.x=t}get y2(){return this._pt2.y}set y2(t){this._pt2.y=t}}class et{constructor(t,e,r){h(this,"container");h(this,"rectangle");h(this,"lines");h(this,"addChainBtn");h(this,"coordReqCallback");this.container=t,this.lines=[],this.addChainBtn=e,this.coordReqCallback=r,this.rectangle=new A(document.querySelector("#rect-div"),this.coordReqCallback),this.setupListeners()}addChain(){let t=new z(this.container,this.coordReqCallback);return this.lines.push(t),this.container.scroll(0,this.container.scrollHeight),t}removeFigure(t){this.lines=this.lines.filter(e=>e!==t),this.container.removeChild(t.node),this.dispatchUpdate()}clear(){for(this.lines=[];this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.dispatchUpdate()}dispatchUpdate(){this.container.dispatchEvent(new CustomEvent("figure_changed",{bubbles:!0,detail:{node:this.container}}))}setupListeners(){this.setupAddChainListener(),this.setupDelListener()}setupDelListener(){this.container.addEventListener("figure_delete",t=>{t.stopPropagation(),this.removeFigure(t.detail.fig)})}setupAddChainListener(){this.addChainBtn.addEventListener("click",()=>{this.addChain()})}}class I{constructor(t,e,r,s){h(this,"pt1");h(this,"pt2");t instanceof I?(this.pt1=new o(t.pt1),this.pt2=new o(t.pt2)):e instanceof o?(this.pt1=new o(t),this.pt2=new o(e)):(this.pt1=new o(t,e),this.pt2=new o(r,s))}get x1(){return this.pt1.x}get y1(){return this.pt1.y}get x2(){return this.pt2.x}get y2(){return this.pt2.y}set x1(t){this.pt1.x=t}set y1(t){this.pt1.y=t}set x2(t){this.pt2.x=t}set y2(t){this.pt2.y=t}}const it=parseInt("1000",2),st=parseInt("0100",2),nt=parseInt("0010",2),rt=parseInt("0001",2);function U(i,t){let e=0;return i.x<t.xl?e+=rt:i.x>t.xr&&(e+=nt),i.y<t.yt?e+=it:i.y>t.yb&&(e+=st),e}function V(i){try{i._pt1.validate(),i._pt2.validate()}catch{throw new Error("Ошибка ввода углов отсекателя")}return{xl:$(i.x1,i.x2),xr:F(i.x1,i.x2),yt:$(i.y1,i.y2),yb:F(i.y1,i.y2)}}function ht(i,t){i instanceof A&&(i=V(i));let e=i,r=t.pt1,s=t.pt2,n=U(r,e),a=U(s,e),g=1e30;if(!n&&!a)return new I(r,s);if(n&a)return null;let _,C,d,p=0;if(!n)return _=r,d=s,p=2,f();if(!a)return _=s,d=r,p=2,f();return c();function c(){return++p,p>2?new I(_,C):(d=p==1?r:s,f())}function f(){if(r.x==s.x)return v();if(g=(s.y-r.y)/(s.x-r.x),d.x>e.xl)return w();let l=g*(e.xl-d.x)+d.y;return l>=e.yt&&l<=e.yb?(p==1?_=new o(e.xl,l):C=new o(e.xl,l),c()):w()}function w(){if(d.x<e.xr)return v();let l=g*(e.xr-d.x)+d.y;return l>=e.yt&&l<=e.yb?(p==1?_=new o(e.xr,l):C=new o(e.xr,l),c()):v()}function v(){if(m(g)<q)return c();if(d.y>e.yt)return y();let l=(e.yt-d.y)/g+d.x;return l<=e.xr&&l>=e.xl?(p==1?_=new o(l,e.yt):C=new o(l,e.yt),c()):y()}function y(){if(d.y<e.yb)return null;let l=(e.yb-d.y)/g+d.x;return l<=e.xr&&l>=e.xl?(p==1?_=new o(l,e.yb):C=new o(l,e.yb),c()):null}}function at(i,t){let e=[];if(!t.length)return e;let r=V(i);return t.map(s=>ht(r,s)).filter(s=>s instanceof I)}const O=document.querySelector(".c-width"),W=document.querySelector(".c-height");class lt{constructor(t,e,r){h(this,"node");h(this,"out_renderer");h(this,"renderer");h(this,"ctx");h(this,"image");h(this,"ar");h(this,"choosing");h(this,"_width");h(this,"_height");let s=t.canvas.getBoundingClientRect();t.canvas.width=s.width,r.canvas.width=s.width,t.canvas.height=s.height,r.canvas.height=s.height,this.out_renderer=r,this.out_renderer.lineWidth=2,this.renderer=t,this.node=t.canvas,this.renderer.imageSmoothingEnabled=!1,this.ctx=document.createElement("canvas").getContext("2d"),this.ctx.lineWidth=2,this.renderer.lineWidth=2,this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._width=e,this._height=b(this._width/this.ar),this.width=e,this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(0),this.choosing=!1,this.ctx.strokeStyle="black"}get width(){return this._width}set width(t){this._width=t,this._height=b(this._width/this.ar),O.innerHTML=`${this._width}`,W.innerHTML=`${this._height}`,this.resetImage()}get height(){return this._height}set height(t){this._height=b(t),this._width=b(this._height*this.ar),O.innerHTML=`${this._width}`,W.innerHTML=`${this._height}`,this.resetImage()}update(){this.clearCtx(),this.drawImageData()}getBuf(){return this.image}putImageData(t){t instanceof ImageData?(this.image=t,this.update()):t.then(e=>{this.image=e,this.update()},e=>{throw e})}drawImageData(){this.renderer.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.ctx.putImageData(this.image,0,0),this.renderer.drawImage(this.ctx.canvas,0,0,this.width*this.getPixelSize(),b(this.height)*this.getPixelSize())}resizeCtx(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height}clearCtx(){this.ctx.clearRect(0,0,this.width,this.height),this.out_renderer.clearRect(0,0,this.width,this.height)}resetImage(){this.ar=this.renderer.canvas.getBoundingClientRect().width/this.renderer.canvas.getBoundingClientRect().height,this._height=this._width/this.ar,this.resizeCtx(),this.clearCtx(),this.renderer.clearRect(0,0,this.width,this.height),this.image=this.ctx.createImageData(this.width,this.height),this.image.data.fill(0),this.drawImageData()}getPixelSize(){return this.renderer.canvas.getBoundingClientRect().width/this.width}drawLine(t,e,r){let s=this.getBuf(),n,a;e===void 0?a=void 0:e instanceof o?a=r:a=e,a===void 0?n={r:0,g:0,b:0}:typeof a=="string"?n=T(a):n=a,t instanceof I?N(s,t.x1,t.y1,t.x2,t.y2,n):N(s,t.x,t.y,e.x,e.y,n)}drawLines(t,e){if(!t.length)return;let r=this.getBuf(),s;if(e!==void 0&&e!=""?s=T(e):s={r:0,g:0,b:0},t[0]instanceof z)for(let n of t)try{n.draw(r,s)}catch(a){console.log(a)}else for(let n of t)try{this.drawLine(n,s)}catch(a){console.log(a)}this.drawImageData()}drawRect(t,e){let r=this.getBuf(),s;e!==void 0&&e!=""?s=T(e):s={r:0,g:0,b:0},t.draw(r,s),this.drawImageData()}}class dt{constructor(){h(this,"state","idle");h(this,"ff");h(this,"graphics");h(this,"blocker");h(this,"blockertext");h(this,"docff");h(this,"canv");h(this,"outline_canv");this.docff=document.querySelector("#figures"),this.ff=new et(this.docff,document.querySelector("#add_line"),t=>this.reqCanvasCoords(t)),this.blocker=document.querySelector(".blocker"),this.blockertext=document.querySelector(".blockertext"),this.canv=document.querySelector("#main_canvas"),this.outline_canv=document.querySelector("#outline_canvas"),this.graphics=new lt(this.canv.getContext("2d"),this.canv.getBoundingClientRect().width,this.outline_canv.getContext("2d")),this.setupListeners()}setupListeners(){this.setupFiguresListeners(),this.setupClearListener(),this.setupFillListener()}setupFillListener(){const t=document.querySelector("#i-color-res");document.querySelector("#cut").addEventListener("click",()=>{try{let e=at(this.ff.rectangle,this.ff.lines);console.log(e),this.graphics.drawLines(e,t.value)}catch(e){J(e)}})}setupClearListener(){document.querySelector("#clear").addEventListener("click",()=>{this.ff.clear()})}setupFiguresListeners(){this.docff.addEventListener("figure_changed",t=>{t.stopPropagation(),this.update()}),this.ff.rectangle.node.addEventListener("figure_changed",t=>{t.stopPropagation(),this.update()})}update(){const t=document.querySelector("#i-color-rect"),e=document.querySelector("#i-color-line");this.graphics.resetImage();try{this.graphics.drawRect(this.ff.rectangle,t.value)}catch(r){console.log(r)}try{this.graphics.drawLines(this.ff.lines,e.value)}catch(r){console.log(r)}}reqCanvasCoords(t){return new Promise(e=>{if(this.state!=="idle")throw new Error(`Приложение занято. Текущее состояние: ${this.state}`);this.toggleInterface(!1,t),this.state="picking";let r=a=>{n(),e(j(this.outline_canv,a))},s=a=>{throw a.preventDefault(),n(),new Error("Rightclick")};this.outline_canv.addEventListener("click",r),this.outline_canv.addEventListener("contextmenu",s);let n=()=>{this.outline_canv.removeEventListener("click",r),this.outline_canv.removeEventListener("contextmenu",s),this.state="idle",this.toggleInterface(!0)}})}toggleInterface(t,e){t?(this.blocker.classList.remove("active"),this.blockertext.innerText=""):(this.blocker.classList.add("active"),this.blockertext.innerText=e!==void 0?e:"")}}new dt;
